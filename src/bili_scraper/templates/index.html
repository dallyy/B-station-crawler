<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>B 站爬虫 - 管理界面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="p-4">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">B 站爬虫</a>
          <div class="d-flex">
            <button id="scrapeBtn" class="btn btn-primary me-2" onclick="startScrape()">立即抓取</button>
            <button id="deleteBtn" class="btn btn-danger me-2" onclick="deleteResults()">删除数据</button>
            <a class="btn btn-outline-secondary" href="/results.json">下载 JSON</a>
          </div>
        </div>
      </nav>

      <div class="row mb-3">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">最近运行</h5>
              {% if last_run %}
              <p class="card-text mb-1"><strong>状态:</strong> <span class="badge bg-{{ 'success' if last_run.status == 'success' else 'danger' }}">{{ last_run.status }}</span></p>
              <p class="card-text mb-1"><strong>处理数量:</strong> {{ last_run.processed_count }}</p>
              <p class="card-text mb-0"><strong>时间:</strong> {{ last_run.started_at | format_ts }} — {{ last_run.finished_at | format_ts }}</p>
              {% else %}
              <p class="card-text">尚未运行。</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">结果摘要</h5>
              <p class="card-text">共 <strong>{{ pagination.total }}</strong> 条匹配，当前第 <strong>{{ pagination.page }}</strong> 页 / 共 <strong>{{ pagination.total_pages }}</strong> 页。</p>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mt-2 mb-0">匹配结果</h3>
        <a class="btn btn-link btn-sm" href="/results.json">下载JSON</a>
      </div>

      <table class="table table-hover table-sm">
        <thead class="table-light">
          <tr><th>BVID</th><th>标题</th><th>热度</th><th>发布</th><th>链接</th></tr>
        </thead>
        <tbody>
        {% for v in videos %}
          <tr>
            <td class="align-middle" style="width:140px"><code>{{ v.bvid }}</code></td>
            <td class="align-middle">{{ v.title | safe }}</td>
            <td class="align-middle"><span class="badge bg-secondary">{{ v.hot }}</span></td>
            <td class="align-middle" style="width:160px">{{ v.pubdate | format_ts }}</td>
            <td class="align-middle" style="width:90px"><a class="btn btn-sm btn-outline-primary" href="{{ v.url }}" target="_blank">打开</a></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      {% if pagination and pagination.total_pages > 1 %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination">
          <li class="page-item {% if pagination.page <= 1 %}disabled{% endif %}"><a class="page-link" href="?page={{ pagination.page - 1 }}">&laquo; Prev</a></li>
          {% set start = pagination.page-2 if pagination.page-2>1 else 1 %}
          {% set end = pagination.page+2 if pagination.page+2 < pagination.total_pages else pagination.total_pages %}
          {% if start > 1 %}
            <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
            {% if start > 2 %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
          {% endif %}
          {% for p in range(start, end+1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="?page={{ p }}">{{ p }}</a></li>
          {% endfor %}
          {% if end < pagination.total_pages %}
            {% if end < pagination.total_pages -1 %}
              <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item"><a class="page-link" href="?page={{ pagination.total_pages }}">{{ pagination.total_pages }}</a></li>
          {% endif %}
          <li class="page-item {% if pagination.page >= pagination.total_pages %}disabled{% endif %}"><a class="page-link" href="?page={{ pagination.page + 1 }}">Next &raquo;</a></li>
        </ul>
      </nav>
      {% endif %}

      <!-- Toast for feedback -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="scrapeToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <strong class="me-auto">爬虫</strong>
            <small class="text-muted">现在</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body" id="scrapeToastBody">任务已开始</div>
        </div>
      </div>

      <style>
        em.keyword { background: rgba(255,200,0,0.2); color:#b00; font-weight:700; padding:0 2px; }
      </style>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        async function checkStatus(){
          try{
            const res = await fetch('/api/status');
            const j = await res.json();
            const btn = document.getElementById('scrapeBtn');
            if(j.running){
              btn.disabled = true;
              btn.innerText = '正在抓取...';
            } else {
              btn.disabled = false;
              btn.innerText = '立即抓取';
            }
          } catch(e){
            console.error(e);
          }
        }

        async function startScrape(){
          const btn = document.getElementById('scrapeBtn');
          btn.disabled = true;
          btn.innerText = '开始中...';
          try{
            const res = await fetch('/scrape', {method:'POST'});
            if(res.status === 200 || res.status === 202){
              const body = await res.json();
              const toastEl = document.getElementById('scrapeToast');
              document.getElementById('scrapeToastBody').innerText = '爬取任务已启动';
              new bootstrap.Toast(toastEl).show();
              // poll status until finished
              const poll = setInterval(async ()=>{
                const s = await fetch('/api/status');
                const j = await s.json();
                if(!j.running){
                  clearInterval(poll);
                  btn.disabled = false;
                  btn.innerText = '立即抓取';
                  document.getElementById('scrapeToastBody').innerText = '爬取已完成';
                  new bootstrap.Toast(document.getElementById('scrapeToast')).show();
                  // reload page to show new results
                  setTimeout(()=>location.reload(), 1000);
                }
              }, 2000);
            } else {
              const txt = await res.text();
              alert('启动失败: '+txt);
              btn.disabled = false;
              btn.innerText = '立即抓取';
            }
          } catch(e){
            alert('错误: '+e);
            btn.disabled = false;
            btn.innerText = '立即抓取';
          }
        }

        async function deleteResults(){
          if(!confirm('确定要删除所有结果数据吗？此操作不可撤销。')){
            return;
          }
          const btn = document.getElementById('deleteBtn');
          btn.disabled = true;
          try{
            const res = await fetch('/api/delete-results', {method:'POST'});
            if(res.ok){
              const data = await res.json();
              document.getElementById('scrapeToastBody').innerText = data.message || '数据已删除';
              new bootstrap.Toast(document.getElementById('scrapeToast')).show();
              setTimeout(()=>location.reload(), 1000);
            } else {
              alert('删除失败: '+await res.text());
              btn.disabled = false;
            }
          } catch(e){
            alert('错误: '+e);
            btn.disabled = false;
          }
        }

        // initial status check
        checkStatus();
      </script>
    </div>
  </body>
</html>